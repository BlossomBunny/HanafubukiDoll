<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Studio Heart - HanafubukiDoll</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: #fdfbfb; color: #1f2937; }
        .tab-btn { @apply px-6 py-2 rounded-2xl font-black text-[10px] uppercase tracking-widest transition-all border-2 border-transparent opacity-40; }
        .tab-btn.active { @apply bg-white border-pink-100 text-pink-500 shadow-sm opacity-100; }
        .glass-card { @apply bg-white/80 backdrop-blur-md border border-pink-100 rounded-[2.5rem] shadow-sm; }
        .status-badge { @apply px-3 py-1 rounded-full text-[9px] font-black uppercase tracking-tighter; }
        .bg-status-inquiry { background: #fef3c7; color: #92400e; }
        .bg-status-painting { background: #fce7f3; color: #9d174d; }
        .bg-status-arrived { background: #dbeafe; color: #1e40af; }
        .bg-status-queued { background: #f3f4f6; color: #374151; }
        
        /* Toggle Switch Styling */
        .switch { position: relative; display: inline-block; width: 50px; height: 26px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #fee2e2; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #f472b6; }
        input:checked + .slider:before { transform: translateX(24px); }
        
        .empty-state { @apply flex flex-col items-center justify-center py-20 text-center space-y-4 bg-pink-50/30 rounded-[3rem] border-2 border-dashed border-pink-100; }
    </style>
</head>
<body>

    <header class="sticky top-0 z-50 bg-white/90 backdrop-blur-md border-b border-pink-50 p-4">
        <div class="max-w-7xl mx-auto flex flex-col md:flex-row items-center justify-between gap-4">
            <div class="flex items-center gap-4">
                <span class="text-2xl">üê∞</span>
                <nav class="flex gap-1 bg-pink-50/50 p-1 rounded-[1.5rem]">
                    <button onclick="switchTab('welcome')" id="tab-welcome" class="tab-btn active">Welcome</button>
                    <button onclick="switchTab('workbench')" id="tab-workbench" class="tab-btn">Inbox</button>
                    <button onclick="switchTab('planner')" id="tab-planner" class="tab-btn">Planner ‚ô°</button>
                    <button onclick="switchTab('settings')" id="tab-settings" class="tab-btn">Settings ‚öôÔ∏è</button>
                </nav>
            </div>
            <a href="index.html" class="text-[10px] font-black uppercase tracking-widest text-pink-300 hover:text-pink-500 transition-colors">Exit to Site ‚Üí</a>
        </div>
    </header>

    <main class="max-w-5xl mx-auto p-6 pb-32">
        
        <div id="view-welcome" class="space-y-8">
            <div class="glass-card p-12 text-center">
                <h1 class="text-4xl font-black tracking-tighter mb-4">Hello Dani & Jas! üå∏</h1>
                <p class="opacity-50 text-sm">Your studio currently has <span id="active-count" class="font-bold text-pink-500">...</span> active projects.</p>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-8">
                    <button onclick="switchTab('workbench')" class="p-8 bg-pink-50 rounded-[2rem] hover:scale-[1.02] transition-transform text-left">
                        <span class="text-2xl">üì•</span>
                        <h3 class="font-bold mt-2">Check Inquiries</h3>
                        <p class="text-[10px] uppercase tracking-widest opacity-40">New orders & photos</p>
                    </button>
                    <button onclick="switchTab('planner')" class="p-8 bg-emerald-50 rounded-[2rem] hover:scale-[1.02] transition-transform text-left">
                        <span class="text-2xl">üé®</span>
                        <h3 class="font-bold mt-2">Open Planner</h3>
                        <p class="text-[10px] uppercase tracking-widest opacity-40">Who is next to paint?</p>
                    </button>
                </div>
            </div>
        </div>

        <div id="view-settings" class="hidden space-y-6">
            <h2 class="text-2xl font-black italic px-4">Studio Control Panel</h2>
            <div class="glass-card p-8">
                <div id="services-list" class="space-y-4">
                    <p class="text-center italic opacity-30 py-4 text-sm">Connecting...</p>
                </div>
            </div>
        </div>

        <div id="view-workbench" class="hidden space-y-6">
             <div id="commissionList" class="grid gap-4"></div>
        </div>

        <div id="view-planner" class="hidden space-y-6">
            <div id="plannerContainer"></div>
        </div>

    </main>

    <div id="detailDrawer" class="fixed inset-y-0 right-0 w-full md:w-[650px] bg-white z-[100] transform translate-x-full transition-transform duration-500 border-l border-pink-100 flex flex-col shadow-2xl">
        <div class="p-6 border-b flex justify-between items-center bg-pink-50/10">
            <div>
                <h2 id="drawerTitle" class="font-black text-xl text-pink-500 italic">Project Workspace</h2>
                <p id="drawerSub" class="text-[10px] font-bold uppercase opacity-40"></p>
            </div>
            <button onclick="closeDrawer()" class="text-3xl hover:rotate-90 transition-transform">&times;</button>
        </div>
        <div id="drawerContent" class="p-8 flex-1 overflow-y-auto space-y-10 pb-32"></div>
        <div class="p-6 bg-white border-t border-pink-100 flex gap-4">
            <button onclick="handleDelete()" class="px-6 py-4 rounded-2xl font-black text-[10px] uppercase tracking-widest text-red-400 hover:bg-red-50 transition-colors">Reject/Delete</button>
            <button id="saveBtn" class="flex-1 bg-pink-500 text-white py-4 rounded-2xl font-black shadow-lg hover:brightness-110 active:scale-95 transition-all">Save Changes ‚ô°</button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        const SUPABASE_URL = 'https://hxqxinfdeyprkuvvyqet.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_J6MAvzpyVHd_zo6PtEcnzQ_L6AVEDZE';
        const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        let activeJobId = null;

        async function switchTab(tab) {
            ['view-welcome', 'view-workbench', 'view-planner', 'view-settings'].forEach(id => {
                const el = document.getElementById(id);
                if(el) el.classList.add('hidden');
            });
            document.getElementById(`view-${tab}`).classList.remove('hidden');
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(`tab-${tab}`).classList.add('active');
            
            if(tab === 'settings') renderSettings();
            if(tab === 'planner') renderPlanner();
            if(tab === 'workbench') renderWorkbench();
            if(tab === 'welcome') updateActiveCount();
        }

        async function renderSettings() {
            const { data: services } = await _supabase.from('studio_settings').select('*');
            const list = document.getElementById('services-list');
            list.innerHTML = services.map(s => `
                <div class="flex items-center justify-between p-6 bg-pink-50/30 rounded-3xl border border-pink-100">
                    <div>
                        <h4 class="font-black text-lg capitalize">${s.id}</h4>
                        <p class="text-[10px] font-bold uppercase ${s.is_live ? 'text-emerald-500' : 'text-amber-500'}">
                            Currently: ${s.is_live ? 'Open' : 'Waitlist'}
                        </p>
                    </div>
                    <label class="switch">
                        <input type="checkbox" ${s.is_live ? 'checked' : ''} onchange="toggleService('${s.id}', this.checked)">
                        <span class="slider"></span>
                    </label>
                </div>
            `).join('');
        }

        async function toggleService(id, status) {
            await _supabase.from('studio_settings').update({ is_live: status }).eq('id', id);
            renderSettings();
        }

        async function renderWorkbench() {
            const { data } = await _supabase.from('commissions').select('*').eq('archived', false).order('created_at', { ascending: false });
            const container = document.getElementById('commissionList');
            if (!data || data.length === 0) {
                container.innerHTML = `<div class="empty-state"><h3>Inbox is quiet... üïäÔ∏è</h3></div>`;
                return;
            }
            container.innerHTML = data.map(job => `
                <div class="glass-card p-6 flex items-center justify-between hover:border-pink-300 cursor-pointer" onclick="openDrawer('${job.id}')">
                    <div class="flex items-center gap-6">
                        <div class="w-16 h-16 rounded-2xl bg-pink-50 overflow-hidden border">
                            ${job.faceup_details?.images?.[0] ? `<img src="${job.faceup_details.images[0]}" class="w-full h-full object-cover">` : 'üé®'}
                        </div>
                        <div>
                            <h3 class="font-black text-lg">${job.social_handle}</h3>
                            <p class="text-[10px] font-bold opacity-40 uppercase">${job.doll_sculpt}</p>
                        </div>
                    </div>
                    <span class="status-badge bg-status-${job.status}">${job.status}</span>
                </div>
            `).join('');
        }

        async function renderPlanner() {
            const { data: jobs } = await _supabase.from('commissions').select('*').in('status', ['arrived', 'painting']).eq('archived', false);
            const container = document.getElementById('plannerContainer');
            if (!jobs || jobs.length === 0) {
                container.innerHTML = `<div class="empty-state"><h3>Yay! Your diary is all clear! ‚ú®</h3></div>`;
                return;
            }
            container.innerHTML = jobs.map(job => `
                <div class="glass-card p-6 flex justify-between items-center border-l-8 ${job.is_fully_paid ? 'border-emerald-400' : 'border-amber-400'}">
                    <div><h3 class="font-black">${job.social_handle}</h3><p class="text-[10px] opacity-40 uppercase">${job.status}</p></div>
                    <button onclick="openDrawer('${job.id}')" class="bg-pink-500 text-white px-4 py-2 rounded-xl text-xs font-black">Work</button>
                </div>
            `).join('');
        }

        async function openDrawer(id) {
            activeJobId = id;
            const { data: job } = await _supabase.from('commissions').select('*').eq('id', id).single();
            const content = document.getElementById('drawerContent');
            const allImages = [...(job.faceup_details?.images || []), ...(job.manicure_details?.images || [])];

            content.innerHTML = `
                <div class="space-y-8">
                    <div class="grid grid-cols-3 gap-2">
                        ${allImages.map(img => `<img src="${img}" class="rounded-xl aspect-square object-cover border">`).join('')}
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <select id="updateStatus" class="p-4 bg-pink-50 rounded-2xl border font-bold">
                            <option value="inquiry">Inquiry</option>
                            <option value="queued">Queued</option>
                            <option value="arrived">Arrived üì¶</option>
                            <option value="painting">Painting üé®</option>
                            <option value="shipped">Shipped ‚úàÔ∏è</option>
                        </select>
                        <select id="updatePaid" class="p-4 bg-pink-50 rounded-2xl border font-bold">
                            <option value="false">Unpaid</option>
                            <option value="true">Fully Paid ‚ô°</option>
                        </select>
                    </div>
                    <textarea id="updateInventory" placeholder="Inventory (Headcaps, wigs etc)" class="w-full p-4 border rounded-2xl h-24">${job.admin_inventory || ''}</textarea>
                    <textarea id="updateNotes" placeholder="Artist Notes" class="w-full p-4 border rounded-2xl h-24">${job.internal_notes || ''}</textarea>
                </div>
            `;
            document.getElementById('updateStatus').value = job.status;
            document.getElementById('updatePaid').value = job.is_fully_paid.toString();
            document.getElementById('detailDrawer').classList.remove('translate-x-full');
        }

        document.getElementById('saveBtn').onclick = async () => {
            await _supabase.from('commissions').update({
                status: document.getElementById('updateStatus').value,
                is_fully_paid: document.getElementById('updatePaid').value === 'true',
                admin_inventory: document.getElementById('updateInventory').value,
                internal_notes: document.getElementById('updateNotes').value
            }).eq('id', activeJobId);
            closeDrawer();
            switchTab(document.querySelector('.tab-btn.active').id.split('-')[1]);
        };

        async function handleDelete() {
            if (confirm("Archive this request?")) {
                await _supabase.from('commissions').update({ archived: true }).eq('id', activeJobId);
                closeDrawer();
                renderWorkbench();
            }
        }

        async function updateActiveCount() {
            const { count } = await _supabase.from('commissions').select('*', { count: 'exact', head: true }).in('status', ['queued', 'arrived', 'painting']).eq('archived', false);
            document.getElementById('active-count').innerText = count || 0;
        }

        function closeDrawer() { document.getElementById('detailDrawer').classList.add('translate-x-full'); }
        window.onload = () => switchTab('welcome');
    </script>
</body>
</html>
