<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Studio Manager - HanafubukiDoll</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; }
        .tab-btn { transition: all 0.2s; border-bottom: 3px solid transparent; opacity: 0.5; }
        .tab-btn.active { border-color: #f472b6; color: #f472b6; font-weight: 800; opacity: 1; }
        .bg-status-inquiry { background-color: #fef3c7; color: #92400e; }
        .bg-status-arrived { background-color: #dbeafe; color: #1e40af; }
        .bg-status-painting { background-color: #fce7f3; color: #9d174d; }
        .bg-status-shipped { background-color: #d1fae5; color: #065f46; }
        .status-badge { padding: 4px 10px; border-radius: 99px; font-size: 10px; font-weight: 800; text-transform: uppercase; }
        .glass-card { background: white; border: 1px solid #fce7f3; border-radius: 1.5rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); }
    </style>
</head>
<body class="bg-[#fdfbfb] min-h-screen">

    <header class="sticky top-0 z-50 bg-white/80 backdrop-blur-md border-b border-pink-100 p-4">
        <div class="max-w-7xl mx-auto flex items-center justify-between">
            <div class="flex gap-8 items-center">
                <h1 class="font-black text-xl tracking-tighter">üê∞ Studio Admin</h1>
                <nav class="flex gap-6">
                    <button onclick="switchTab('workbench')" id="tab-workbench" class="tab-btn active text-xs uppercase tracking-widest pb-1">Commissions</button>
                    <button onclick="switchTab('planner')" id="tab-planner" class="tab-btn text-xs uppercase tracking-widest pb-1">Planner ‚ô°</button>
                    <button onclick="switchTab('waitlist')" id="tab-waitlist" class="tab-btn text-xs uppercase tracking-widest pb-1">Waitlist</button>
                </nav>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto p-6 pb-24">
        
        <div id="view-workbench" class="space-y-6">
            <div class="flex justify-between items-center">
                <h2 class="text-2xl font-black italic">Recent Inquiries</h2>
                <div class="flex gap-4">
                    <label class="text-[10px] font-bold flex items-center gap-2"><input type="checkbox" id="filterRejected" onchange="fetchData()" checked> Hide Rejected</label>
                    <label class="text-[10px] font-bold flex items-center gap-2"><input type="checkbox" id="filterCompleted" onchange="fetchData()" checked> Hide Shipped</label>
                </div>
            </div>
            <div class="bg-white rounded-3xl border border-pink-50 overflow-hidden shadow-sm">
                <table class="w-full text-left">
                    <thead class="bg-pink-50/30 text-[10px] font-black uppercase tracking-widest text-gray-400">
                        <tr><th class="p-6">Client</th><th class="p-6">Doll</th><th class="p-6">Status</th><th class="p-6 text-right">Action</th></tr>
                    </thead>
                    <tbody id="mainTableBody"></tbody>
                </table>
            </div>
        </div>

        <div id="view-planner" class="hidden space-y-6"></div>

        <div id="view-waitlist" class="hidden space-y-6">
            <h2 class="text-2xl font-black italic text-gray-400">Waitlist Management</h2>
            <div id="waitlistContainer" class="grid gap-4"></div>
        </div>
    </main>

    <div id="detailDrawer" class="fixed inset-y-0 right-0 w-full md:w-[600px] bg-white z-[100] transform translate-x-full transition-transform duration-300 border-l border-pink-100 flex flex-col shadow-2xl">
        <div class="p-6 border-b flex justify-between items-center bg-pink-50/10">
            <h2 class="font-black text-xl text-pink-500 italic">Project Workspace</h2>
            <button onclick="closeDrawer()" class="text-3xl hover:text-pink-500 transition-colors">&times;</button>
        </div>
        
        <div id="drawerContent" class="p-8 flex-1 overflow-y-auto space-y-10 pb-32">
            </div>

        <div class="absolute bottom-0 left-0 right-0 p-6 bg-white border-t border-pink-100 shadow-[0_-10px_20px_rgba(0,0,0,0.02)]">
            <button id="saveBtn" class="w-full bg-pink-500 text-white py-4 rounded-2xl font-black shadow-lg hover:brightness-110 active:scale-95 transition-all">
                Save & Update Records ‚ô°
            </button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        const SUPABASE_URL = 'https://hxqxinfdeyprkuvvyqet.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_J6MAvzpyVHd_zo6PtEcnzQ_L6AVEDZE';
        const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        let activeJobId = null;

        function switchTab(tab) {
            ['view-workbench', 'view-waitlist', 'view-planner'].forEach(id => document.getElementById(id).classList.add('hidden'));
            document.getElementById(`view-${tab}`).classList.remove('hidden');
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(`tab-${tab}`).classList.add('active');
            
            if(tab === 'planner') renderPlanner();
            if(tab === 'waitlist') fetchWaitlist();
            if(tab === 'workbench') fetchData();
        }

        async function fetchData() {
            let query = _supabase.from('commissions').select('*').order('created_at', { ascending: false });
            if (document.getElementById('filterRejected').checked) query = query.neq('status', 'rejected');
            if (document.getElementById('filterCompleted').checked) query = query.neq('status', 'shipped');
            const { data } = await query;
            
            const tbody = document.getElementById('mainTableBody');
            tbody.innerHTML = data.map(job => `
                <tr class="border-b border-pink-50 hover:bg-pink-50/20">
                    <td class="p-6">
                        <span class="font-bold block">${job.social_handle || 'No Social'}</span>
                        <span class="text-[10px] opacity-40">${job.customer_email}</span>
                    </td>
                    <td class="p-6 font-bold text-pink-500 text-sm">${job.doll_sculpt}</td>
                    <td class="p-6"><span class="status-badge bg-status-${job.status}">${job.status}</span></td>
                    <td class="p-6 text-right"><button onclick="openDrawer('${job.id}')" class="font-black text-xs uppercase underline hover:text-pink-500">Edit</button></td>
                </tr>
            `).join('');
        }

        async function renderPlanner() {
            const { data: jobs } = await _supabase.from('commissions').select('*').in('status', ['arrived', 'painting']);
            const container = document.getElementById('view-planner');
            
            const sorted = jobs.map(j => {
                const arrival = j.arrived_at ? new Date(j.arrived_at) : new Date();
                const days = Math.floor((new Date() - arrival) / (1000 * 60 * 60 * 24));
                const score = (j.is_fully_paid ? 10 : 0) + (days / 3);
                return { ...j, score, days };
            }).sort((a, b) => b.score - a.score);

            container.innerHTML = `
                <h2 class="text-2xl font-black italic">Production Planner</h2>
                <div class="grid gap-4">
                    ${sorted.length ? sorted.map(job => `
                        <div class="bg-white p-6 rounded-3xl border-2 ${job.is_fully_paid ? 'border-emerald-100' : 'border-amber-100'} flex justify-between items-center shadow-sm">
                            <div>
                                <h3 class="font-black text-lg">${job.social_handle} <span class="text-sm font-normal opacity-40">‚Äî ${job.doll_sculpt}</span></h3>
                                <p class="text-[10px] font-bold uppercase text-pink-500 mt-1">${job.days} Days in Studio</p>
                            </div>
                            <button onclick="openDrawer('${job.id}')" class="bg-pink-500 text-white px-6 py-2 rounded-xl text-xs font-black">Work</button>
                        </div>
                    `).join('') : '<p class="opacity-50 italic">Planner is empty. Check your arrived dolls!</p>'}
                </div>
            `;
        }

        async function openDrawer(id) {
            activeJobId = id;
            const { data: job } = await _supabase.from('commissions').select('*').eq('id', id).single();
            const content = document.getElementById('drawerContent');

            content.innerHTML = `
                <div class="grid grid-cols-2 gap-4">
                    <div class="space-y-1">
                        <label class="text-[10px] font-black uppercase opacity-40 text-gray-500">Job Status</label>
                        <select id="updateStatus" class="w-full p-3 bg-pink-50/30 rounded-xl border border-pink-100 font-bold text-sm">
                            <option value="inquiry" ${job.status === 'inquiry' ? 'selected' : ''}>Inquiry</option>
                            <option value="queued" ${job.status === 'queued' ? 'selected' : ''}>Queued</option>
                            <option value="arrived" ${job.status === 'arrived' ? 'selected' : ''}>Arrived üì¶</option>
                            <option value="painting" ${job.status === 'painting' ? 'selected' : ''}>Painting üé®</option>
                            <option value="shipped" ${job.status === 'shipped' ? 'selected' : ''}>Shipped ‚úàÔ∏è</option>
                        </select>
                    </div>
                    <div class="space-y-1">
                        <label class="text-[10px] font-black uppercase opacity-40 text-gray-500">Payment Status</label>
                        <select id="updatePaid" class="w-full p-3 bg-pink-50/30 rounded-xl border border-pink-100 font-bold text-sm">
                            <option value="false" ${!job.is_fully_paid ? 'selected' : ''}>Deposit Only</option>
                            <option value="true" ${job.is_fully_paid ? 'selected' : ''}>Fully Paid ‚ô°</option>
                        </select>
                    </div>
                </div>

                <hr class="border-pink-50">

                <div class="space-y-4">
                    <h3 class="text-[10px] font-black uppercase text-pink-400 tracking-widest">üì¶ Physical Inventory (Private)</h3>
                    <textarea id="updateInventory" placeholder="Record what came in the box: E.G. Headcap, default eyes (blue), blonde wig, protective pouch..." 
                        class="w-full p-4 rounded-2xl border border-pink-100 text-sm h-28 bg-pink-50/10 placeholder:opacity-30">${job.admin_inventory || ''}</textarea>
                    
                    <h3 class="text-[10px] font-black uppercase text-pink-400 tracking-widest pt-2">üìù Internal Workflow Notes</h3>
                    <textarea id="updateInternalNotes" placeholder="Artist notes only: E.G. Needs extra sanding, client requested pale blush tones..." 
                        class="w-full p-4 rounded-2xl border border-pink-100 text-sm h-28 bg-pink-50/10 placeholder:opacity-30">${job.internal_notes || ''}</textarea>
                </div>

                <hr class="border-pink-50">

                <div class="space-y-2 opacity-60">
                    <h3 class="text-[10px] font-black uppercase text-gray-400 tracking-widest">Client Request</h3>
                    <p class="text-xs font-bold">${job.doll_sculpt}</p>
                    <p class="text-xs italic">"${job.notes || 'No public notes provided.'}"</p>
                </div>
            `;
            document.getElementById('detailDrawer').classList.remove('translate-x-full');
        }

        document.getElementById('saveBtn').onclick = async () => {
            const btn = document.getElementById('saveBtn');
            btn.innerText = "Saving Changes...";
            btn.disabled = true;
            
            const { error } = await _supabase.from('commissions').update({
                status: document.getElementById('updateStatus').value,
                is_fully_paid: document.getElementById('updatePaid').value === 'true',
                admin_inventory: document.getElementById('updateInventory').value,
                internal_notes: document.getElementById('updateInternalNotes').value
            }).eq('id', activeJobId);

            if(!error) {
                btn.innerText = "Updated Successfully! ‚ô°";
                setTimeout(() => { 
                    closeDrawer(); 
                    const currentTab = document.querySelector('.tab-btn.active').id.split('-')[1];
                    switchTab(currentTab);
                    btn.disabled = false;
                    btn.innerText = "Save & Update Records ‚ô°";
                }, 800);
            } else {
                alert("Error: " + error.message);
                btn.disabled = false;
                btn.innerText = "Save & Update Records ‚ô°";
            }
        };

        function closeDrawer() { document.getElementById('detailDrawer').classList.add('translate-x-full'); }
        window.onload = () => fetchData();
    </script>
</body>
</html>
