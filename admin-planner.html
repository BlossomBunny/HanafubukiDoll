<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - HanafubukiDoll</title>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="global-utils.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="global-style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<link href='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.20/index.global.min.css' rel='stylesheet' />
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.20/index.global.min.js'></script>

    <style type="text/tailwindcss">
             @layer components {
            .nav-btn { 
                @apply px-5 py-2 rounded-full font-bold text-sm transition-all cursor-pointer inline-block; 
            }
            .nav-btn-pink { 
                @apply bg-pink-50 text-pink-500 hover:bg-pink-100; 
            }
            .nav-btn-mint { 
                @apply bg-emerald-50 text-emerald-600 hover:bg-emerald-100; 
            }

          .auth-hidden { @apply hidden !important; }
            
            .glass-card { 
                background: rgba(255, 255, 255, 0.8); 
                backdrop-filter: blur(12px); 
                @apply rounded-[2rem] border border-pink-100/20; 
            }

            .img-enlarge { 
                @apply fixed inset-0 z-[200] w-full h-full object-contain bg-black/90 cursor-zoom-out p-5;
            }
        }

        @keyframes pulse-custom {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.5); opacity: 0; }
        }
        .animate-pulse-custom {
            animation: pulse-custom 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        
        .bounce-bunny { display: inline-block; animation: bounce 2s infinite; }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }

/* --- Airy Calendar Core --- */
.fc { font-family: 'Plus Jakarta Sans', sans-serif !important; border: none !important; }
.fc-theme-standard td, .fc-theme-standard th { border: none !important; }

/* Turn day cells into floating white cards */
.fc-daygrid-day-frame {
    background: #ffffff; /* Solid white */
    border-radius: 1.2rem;
    margin: 6px;
    border: 1px solid #fdf2f8; /* Very faint pink border */
    transition: all 0.3s ease;
    min-height: 100px !important;
    box-shadow: 0 4px 12px rgba(0,0,0,0.02);
}

.fc-day-today .fc-daygrid-day-frame {
    background: #ffffff !important;
    box-shadow: 0 0 0 3px #fbcfe8, 0 8px 20px rgba(0,0,0,0.05); /* Soft pink glow */
}

/* Day numbers as small mint or pink circles */
.fc-daygrid-day-number {
    background: #f0fdfa; /* Mint tint */
    color: #0d9488 !important; /* Mint text */
    font-weight: 800 !important;
    font-size: 10px !important;
    width: 22px;
    height: 22px;
    display: flex !important;
    align-items: center;
    justify-content: center;
    border-radius: 8px;
    margin: 10px !important;
}

/* Weekday Headers (Mon, Tue, etc.) */
.fc-col-header-cell-cushion {
    text-transform: uppercase;
    letter-spacing: 0.15em;
    font-size: 10px !important;
    color: #9ca3af !important; /* Soft gray */
    font-weight: 800 !important;
    padding-bottom: 10px;
}

/* Event Styling: Stickers (Events) vs Washi Tape (Jobs) */
.fc-event {
    border: none !important;
    margin: 2px 6px !important;
    padding: 3px 8px !important;
}

.sticker-style {
    border: 2px solid #ffffff !important; 
    border-radius: 12px !important; 
    box-shadow: 2px 2px 0px rgba(0,0,0,0.03);
    transform: rotate(-1deg);
}

.job-bar-style {
    border-radius: 6px !important;
    opacity: 0.9;
    font-size: 9px !important;
    border-left: 4px solid rgba(0,0,0,0.1) !important; /* Washi tape "edge" */
}
    </style>
</head>
<body class="bg-[#fdfbfb] font-['Plus_Jakarta_Sans']">

    <nav class="p-4 md:p-6 sticky top-0 z-50 bg-white/80 backdrop-blur-md border-b border-pink-50">
    <div class="max-w-6xl mx-auto flex flex-col md:flex-row justify-between items-center gap-4">
        <div class="text-xl md:text-2xl font-black tracking-tighter">
            <span class="bounce-bunny">üê∞</span> HanafubukiDoll üå∏
        </div>
        
    <div id="adminNav" class="flex flex-wrap justify-center gap-2 md:gap-4">
    <a href="admin-index.html" class="nav-btn nav-btn-pink">Dashboard ‚ô°</a>
    <a href="admin-workbench.html" class="nav-btn nav-btn-pink">Workbench ‚ô°</a>
    <a href="admin-planner.html" class="nav-btn nav-btn-pink">Planner ‚ô°</a>
    <a href="admin-inventory.html" class="nav-btn nav-btn-pink">Inventory ‚ô°</a>
    <a href="admin-financial.html" class="nav-btn nav-btn-mint">Financials ‚ô°</a>
    <button onclick="handleLogout()" class="nav-btn nav-btn-pink opacity-50">Logout ‚èª</button>
            </div>
        </div>
    </nav>

<main id="adminMain" class="max-w-6xl mx-auto p-4 md:p-10 auth-hidden">
    
<div id="plannerContainer" class="animate-fadeIn mt-6">
    <div class="flex flex-col md:flex-row gap-6">
        
        <div id="sticker-drawer" class="w-full md:w-48 bg-white rounded-[2.5rem] p-6 shadow-sm border border-emerald-50 flex flex-row md:flex-col gap-6 items-center self-start">
            <p class="text-[9px] font-black text-emerald-400 uppercase tracking-widest hidden md:block mb-2">Studio Kit</p>
            
            <div class="sticker-item flex flex-col items-center gap-2 cursor-grab group" data-event='{"title": "STUDIO CLOSED", "type": "holiday"}'>
                <div class="w-12 h-12 bg-pink-50 rounded-2xl flex items-center justify-center text-2xl group-hover:scale-110 transition-transform">üå∏</div>
                <span class="text-[8px] font-black text-pink-400 uppercase text-center">Holiday</span>
            </div>
            
            <div class="sticker-item flex flex-col items-center gap-2 cursor-grab group" data-event='{"title": "Admin & Restock", "type": "personal"}'>
                <div class="w-12 h-12 bg-emerald-50 rounded-2xl flex items-center justify-center text-2xl group-hover:scale-110 transition-transform">‚ú®</div>
                <span class="text-[8px] font-black text-emerald-400 uppercase text-center">Admin</span>
            </div>

            <div id="trash-zone" class="mt-auto w-full flex flex-col items-center gap-2 p-4 rounded-2xl bg-rose-50/30 border-2 border-dashed border-rose-100 opacity-60 hover:opacity-100 transition-all">
                <span class="text-xl">üóëÔ∏è</span>
                <span class="text-[8px] font-black text-rose-400 uppercase">Trash</span>
            </div>
        </div>

        <div class="flex-1 bg-white rounded-[3rem] p-8 shadow-sm border border-pink-50">
            <div class="flex justify-between items-center mb-8 px-2">
                <h2 class="text-2xl font-black italic text-gray-800 tracking-tighter">PLANNER ‚ô°</h2>
                <div class="flex gap-2">
                    <div class="px-3 py-1 bg-emerald-50 rounded-full text-[9px] font-black text-emerald-500 uppercase">Mint = Admin</div>
                    <div class="px-3 py-1 bg-pink-50 rounded-full text-[9px] font-black text-pink-500 uppercase">Pink = Holiday</div>
                </div>
            </div>
            <div id="calendar"></div>
        </div>

    </div>
</div>
    
  <script>
 // --- PLANNER LOGIC --- //
let currentEventId = null;
      
function getJobColor(status, isUrgent) {
    if (isUrgent) return '#fecdd3'; // pink-200
    const colors = {
        'Enquiry': '#ecfeff', // cyan-50 (Minty)
        'Working': '#f0fdf4', // green-50
        'Arrived': '#fff7ed', // orange-50
    };
    return colors[status] || '#ffffff';
}

function showEventModal(id, event = null) {
    currentEventId = id;
    document.getElementById('eventModalTitle').textContent = id ? 'Edit Event' : 'Add Event';
    document.getElementById('deleteEventBtn').classList.toggle('hidden', !id);

    if (event) {
        document.getElementById('eventTitle').value = event.title || '';
        document.getElementById('eventType').value = event.extendedProps?.type || 'other';
        document.getElementById('eventStart').value = event.start ? new Date(event.start).toISOString().slice(0,16) : '';
        document.getElementById('eventEnd').value = event.end ? new Date(event.end).toISOString().slice(0,16) : '';
        document.getElementById('eventDetails').value = event.extendedProps?.details || '';
    } else {
        document.getElementById('eventForm').reset();
    }

    document.getElementById('eventModal').classList.remove('hidden');
}

function closeEventModal() {
    document.getElementById('eventModal').classList.add('hidden');
}

async function saveEvent() {
    const title = document.getElementById('eventTitle').value.trim();
    const type = document.getElementById('eventType').value;
    const start = document.getElementById('eventStart').value;
    const end = document.getElementById('eventEnd').value || null;
    const details = document.getElementById('eventDetails').value.trim();

    // Verification Alert
    if (!title || !start) {
        showMagicAlert("Missing Info! ‚òÅÔ∏è", "Title and start date are required to save an event.", "error");
        return;
    }

    try {
        let error;
        if (currentEventId) {
            ({ error } = await _supabase.from('events').update({
                title, type, start_date: start, end_date: end, details
            }).eq('id', currentEventId));
        } else {
            ({ error } = await _supabase.from('events').insert({
                title, type, start_date: start, end_date: end, details
            }));
        }

        if (error) throw error;

        // Optional Success Alert - You can comment this out if you prefer it just closing silently
        showMagicAlert("Planner Updated! üå∏", "Your event has been safely tucked into the calendar.", "success");

        closeEventModal();
        renderPlanner(); // Refresh calendar
    } catch (err) {
        console.error("Save event error:", err);
        // Error Alert
        showMagicAlert("Save Failed ‚òÅÔ∏è", "Oh no! We couldn't save that: " + err.message, "error");
    }
}
    
async function deleteEvent() {
    showMagicAlert(
        "Delete Event? üéÄ", 
        "Are you sure you want to remove this from the calendar? This cannot be undone.", 
        "confirm", 
        async () => {
            try {
                const { error } = await _supabase.from('events').delete().eq('id', currentEventId);
                if (error) throw error;
                
                // Success feedback
                showMagicAlert("Gone! ‚òÅÔ∏è", "The event has been cleared from your planner.", "success");
                
                closeEventModal();
                renderPlanner();
            } catch (err) {
                console.error("Delete error:", err);
                showMagicAlert("Error ‚òÅÔ∏è", "Failed to delete: " + err.message, "error");
            }
        }
    );
}
       
document.addEventListener('DOMContentLoaded', () => {
    // Check if user is logged in first, then render
    _supabase.auth.getSession().then(({ data: { session } }) => {
        if (session) {
            document.getElementById('adminMain').classList.remove('auth-hidden');
            renderPlanner(); 
        } else {
            window.location.href = 'admin-login.html';
        }
    });
});


async function renderPlanner() {
    const calendarEl = document.getElementById('calendar');
    if (!calendarEl) return;

    calendarEl.innerHTML = ''; 

    try {
        // 1. Fetch Data
        const { data: jobs } = await _supabase.from('commissions').select('*')
            .in('status', ['Enquiry', 'Quote', 'Arrived', 'Working', 'Approved', 'Photo'])
            .order('created_at');

        const { data: events } = await _supabase.from('events').select('*').order('start_date');

        // Initialize Draggable Stickers
        new FullCalendar.Draggable(document.getElementById('sticker-drawer'), {
            itemSelector: '.sticker-item',
            eventData: function(el) {
                return JSON.parse(el.getAttribute('data-event'));
            }
        });

        // 2. Initialize FullCalendar
        const calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth',
            headerToolbar: {
                left: 'prev,next today',
                center: 'title',
                right: ''
            },
            firstDay: 1,
            editable: true,
            selectable: true,
            droppable: true,
            dayMaxEvents: 3,
            
            events: [
                ...jobs.filter(job => job.arrived_at).map(job => {
                    const arrivalDate = new Date(job.arrived_at);
                    const today = new Date();
                    const diffDays = Math.ceil(Math.abs(today - arrivalDate) / (1000 * 60 * 60 * 24));
                    return {
                        id: `job-${job.id}`,
                        title: `üê∞ ${job.social_handle || 'Client'} (Day ${diffDays})`,
                        start: job.arrived_at,
                        allDay: true,
                        backgroundColor: getJobColor(job.status, job.is_urgent),
                        extendedProps: { type: 'job', status: job.status }
                    };
                }),
               ...events.map(event => {
    const isHoliday = event.type === 'holiday';
    return {
        id: event.id,
        title: event.title,
        start: event.start_date,
        end: event.end_date,
        allDay: true,
        // Holiday = Pink, Personal = Mint
        backgroundColor: isHoliday ? '#fce7f3' : '#ccfbf1',
        className: 'sticker-style', 
        borderColor: 'transparent',
        textColor: isHoliday ? '#db2777' : '#0d9488'
    };
})

            // DROPPING A NEW STICKER
            drop: function(info) {
    const droppedData = JSON.parse(info.draggedEl.getAttribute('data-event'));
    
    showEventModal(null, {
        title: droppedData.title,
        start: info.date,
        extendedProps: { type: droppedData.type }
    });

    if (info.draggedEl.parentNode) {
    
    }
},
            // DRAGGING OFF TO THE TRASH CAN
            eventDragStop: function(info) {
                const trashEl = document.getElementById('trash-zone');
                const x = info.jsEvent.clientX;
                const y = info.jsEvent.clientY;
                const rect = trashEl.getBoundingClientRect();

              
                if (x >= rect.left && x <= rect.right && y >= rect.top && y <= rect.bottom) {
                    if (info.event.extendedProps.type === 'event') {
                        currentEventId = info.event.id;
                        deleteEvent(); 
                    } else {
                        showMagicAlert("Wait! üê∞", "You can't trash a Job here, only calendar events!", "error");
                    }
                }
            },

            eventDidMount: function(info) {
                info.el.style.border = 'none';
                info.el.style.borderRadius = '12px';
                info.el.style.padding = '2px 6px';
            },

            eventClick: function(info) {
                if (info.event.extendedProps.type === 'job') {
                    const jobId = info.event.id.replace('job-', '');
                    window.location.href = `admin-workbench.html?id=${jobId}`;
                } else {
                    showEventModal(info.event.id, info.event);
                }
            },

            eventDrop: async function(info) {
                if (info.event.extendedProps.type === 'event') {
                    await _supabase.from('events').update({
                        start_date: info.event.start.toISOString(),
                        end_date: info.event.end ? info.event.end.toISOString() : null
                    }).eq('id', info.event.id);
                }
            }
        });

        calendar.render();
    } catch (err) {
        console.error("Planner error:", err);
    }
}
      
     
    async function handleLogout() {
    try {
        const { error } = await _supabase.auth.signOut();
        if (error) throw error;

        localStorage.removeItem('hana_active_tab');
        
        window.location.href = 'admin-login.html'; 
        
    } catch (err) {
        console.error("Logout error:", err);
        showMagicAlert(
            "Logout Failed", 
            "We couldn't sign you out properly. Please try again! ‚òÅÔ∏è", 
            "error"
        );
    }
}
       </script>
    
<div id="eventModal" class="fixed inset-0 z-[150] hidden bg-black/40 backdrop-blur-sm flex items-center justify-center p-4">
    <div class="bg-white w-full max-w-md rounded-[2.5rem] p-8 shadow-2xl border border-pink-100">
        <h3 id="eventModalTitle" class="text-2xl font-black italic mb-6">Add Event</h3>
        <form id="eventForm" class="space-y-4">
            <input type="text" id="eventTitle" placeholder="Event Title" class="w-full p-4 bg-gray-50 rounded-2xl border-none text-sm font-bold outline-none ring-2 ring-transparent focus:ring-pink-200 transition-all">
            <select id="eventType" class="w-full p-4 bg-gray-50 rounded-2xl border-none text-sm font-bold outline-none">
                <option value="holiday">üå∏ Holiday/Time Off</option>
                <option value="personal">‚ú® Personal/Admin</option>
                <option value="other">üéÄ Other</option>
            </select>
            <div class="grid grid-cols-2 gap-3">
                <input type="datetime-local" id="eventStart" class="p-4 bg-gray-50 rounded-2xl border-none text-xs font-bold">
                <input type="datetime-local" id="eventEnd" class="p-4 bg-gray-50 rounded-2xl border-none text-xs font-bold">
            </div>
            <textarea id="eventDetails" placeholder="Extra notes..." class="w-full p-4 bg-gray-50 rounded-2xl border-none text-sm font-bold h-24 resize-none"></textarea>
            
            <div class="flex gap-3 pt-4">
                <button type="button" id="deleteEventBtn" onclick="deleteEvent()" class="px-6 py-4 text-rose-400 font-black text-[10px] uppercase hidden">Delete</button>
                <button type="button" onclick="closeEventModal()" class="flex-1 py-4 text-gray-400 font-black text-[10px] uppercase">Cancel</button>
                <button type="button" onclick="saveEvent()" class="flex-[2] bg-pink-500 text-white py-4 rounded-2xl font-black shadow-lg hover:bg-pink-600 transition-all">Save ‚ô°</button>
            </div>
        </form>
    </div>
</div>
  <footer class="py-20 text-center border-t border-pink-50 bg-white/30">
        <p class="text-sm tracking-widest uppercase font-bold text-[var(--accent-pink)] mb-4">HanafubukiDoll Aesthetic Studio</p>
        <p class="text-[var(--text-muted)] text-sm mb-6">¬© 2026 ‚Ä¢ Made with cherry blossoms and magic! üê∞üå∏üåô</p>
        </footer>

<div class="fixed bottom-6 left-6 z-[100] flex flex-col items-start gap-4">
    <div id="accessMenu" class="w-72 bg-white rounded-3xl shadow-2xl border border-pink-50 p-6 hidden animate-fadeIn mb-2">
        <div class="flex justify-between items-center mb-6">
            <h3 class="font-black text-[10px] uppercase tracking-widest text-pink-500">Accessibility Settings</h3>
            <button onclick="ComfortSettings.toggleMenu()" class="text-gray-300 hover:text-pink-500 text-2xl" aria-label="Close Menu">&times;</button>
        </div>
        <div class="space-y-5">
            <label class="flex justify-between items-center cursor-pointer group">
                <span class="text-[11px] font-bold text-gray-600 uppercase group-hover:text-pink-400 transition-colors">Dark Mode</span>
                <input type="checkbox" id="darkToggle" onchange="ComfortSettings.update('dark-theme', this.checked)" class="w-5 h-5 accent-pink-500">
            </label>
            <label class="flex justify-between items-center cursor-pointer group">
                <span class="text-[11px] font-bold text-gray-600 uppercase group-hover:text-pink-400 transition-colors">Reduce Motion</span>
                <input type="checkbox" id="motionToggle" onchange="ComfortSettings.update('reduced-motion', this.checked)" class="w-5 h-5 accent-pink-500">
            </label>
            <label class="flex justify-between items-center cursor-pointer group">
                <span class="text-[11px] font-bold text-gray-600 uppercase group-hover:text-pink-400 transition-colors">Dyslexia Font</span>
                <input type="checkbox" id="dyslexiaToggle" onchange="ComfortSettings.update('dyslexia-mode', this.checked)" class="w-5 h-5 accent-pink-500">
            </label>
        </div>
    </div>
    
    <button onclick="ComfortSettings.toggleMenu()" class="access-btn flex items-center gap-2 px-5 py-3 bg-white border-2 border-pink-100 rounded-full shadow-lg hover:scale-105 transition-all" aria-label="Accessibility Settings">
        <span>‚öôÔ∏è</span>
        <span class="text-[11px] font-black uppercase tracking-widest text-gray-700">Accessibility Settings</span>
    </button>
</div>
    
<script src="global-scripts.js"></script>
</body>
</html>
