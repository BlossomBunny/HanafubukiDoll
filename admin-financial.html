<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Financials | HanafubukiDoll Aesthetic Studio</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="global-utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="global-style.css">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        .nav-btn { @apply px-5 py-2 rounded-full font-bold text-sm transition-all; }
        .nav-btn-pink { @apply bg-pink-50 text-pink-500 hover:bg-pink-100; }
        .nav-btn-mint { @apply bg-emerald-50 text-emerald-600 hover:bg-emerald-100; }
        .glass-card { @apply bg-white/70 backdrop-blur-md border border-white/20 rounded-[2rem] shadow-sm; }
    </style>
</head>
<body class="bg-[#fdfbfb]">
    <div class="mesh-bg"></div>

    <nav class="p-4 md:p-6 sticky top-0 z-50 bg-white/80 backdrop-blur-md border-b border-pink-50">
        <div class="max-w-6xl mx-auto flex flex-col md:flex-row justify-between items-center gap-4">
            <div class="text-xl md:text-2xl font-black tracking-tighter">
                <span class="bounce-bunny">üê∞</span> HanafubukiDoll üå∏
            </div>
            <div id="adminNav" class="flex flex-wrap justify-center gap-2 md:gap-4">
                <a href="admin-index.html" class="nav-btn nav-btn-pink">Dashboard ‚ô°</a>
                <a href="admin-workbench.html" class="nav-btn nav-btn-mint">Workbench ‚ô°</a>
                <a href="admin-planner.html" class="nav-btn nav-btn-pink">Planner ‚ô°</a>
                <a href="admin-inventory.html" class="nav-btn nav-btn-mint">Inventory ‚ô°</a>
                <a href="admin-financial.html" class="nav-btn nav-btn-pink border-2 border-pink-200">Financials ‚ô°</a>
                <button onclick="handleLogout()" class="nav-btn nav-btn-mint opacity-50">Logout ‚èª</button>
            </div>
        </div>
    </nav>

    <div class="glass-card p-6 mb-8 bg-gradient-to-r from-pink-50 to-emerald-50 border-none">
    <div class="flex flex-col md:flex-row justify-between items-center gap-4">
        <div class="flex-1 w-full">
            <div class="flex justify-between mb-2">
                <span class="text-[10px] font-black uppercase text-gray-500 tracking-widest">Tax Year Progress</span>
                <span id="daysRemaining" class="text-[10px] font-black uppercase text-pink-500"></span>
            </div>
            <div class="w-full bg-white/50 rounded-full h-3 overflow-hidden border border-pink-100">
                <div id="yearProgressBar" class="bg-pink-400 h-full transition-all duration-1000" style="width: 0%"></div>
            </div>
        </div>
    </div>
</div>
    <main class="max-w-6xl mx-auto p-4 md:p-10 space-y-10">
        <div id="financial-stats" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
            </div>

        <div class="glass-card p-8 bg-white/80">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xs font-black uppercase text-gray-400 tracking-widest">Revenue vs Expenses</h3>
                <select id="taxYearFilter" onchange="renderfinancials()" class="text-[10px] font-bold border-none bg-pink-50 rounded-lg p-2 outline-none text-pink-500 cursor-pointer">
                    <option value="2025-26">Tax Year 25/26</option>
                    <option value="2024-25">Tax Year 24/25</option>
                </select>
            </div>
            <div class="h-[350px]">
                <canvas id="revenueChart"></canvas>
            </div>
        </div>

<div class="glass-card p-8">
    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
        <div>
            <h3 class="text-xs font-black uppercase text-gray-400 tracking-widest">Business Expenses</h3>
            <p class="text-[9px] text-gray-400 mt-1 uppercase font-bold italic">Self-Assessment Records</p>
        </div>
        <div class="flex gap-2">
            <button onclick="exportToCSV()" class="nav-btn nav-btn-pink text-[10px] shadow-sm flex items-center gap-2">
                <span>üíæ</span> Export CSV
            </button>
            <button onclick="openExpenseModal()" class="nav-btn nav-btn-mint text-[10px] shadow-sm flex items-center gap-2">
                <span>+</span> Log Expense
            </button>
        </div>
    </div>

    <div id="expense-pills" class="flex flex-wrap gap-2 mb-8"></div>
    
    </div>
            <div class="overflow-x-auto">
                <table class="w-full text-left">
                    <thead>
                        <tr class="text-[10px] uppercase text-gray-400 border-b border-pink-50">
                            <th class="pb-4 pl-2">Date</th>
                            <th class="pb-4">Category</th>
                            <th class="pb-4">Description</th>
                            <th class="pb-4 text-right">Amount</th>
                            <th class="pb-4 text-center">Receipt</th>
                            <th class="pb-4 text-center">Action</th>
                        </tr>
                    </thead>
                    <tbody id="expense-tbody" class="text-sm">
                        </tbody>
                </table>
            </div>
        </div>
    </main>

    <script>
        let revenueChart = null;

async function renderfinancials() {
    const taxYear = document.getElementById('taxYearFilter').value;
    const [startYear] = taxYear.split('-').map(Number);
    const startDate = new Date(startYear, 3, 6); 
    const endDate = new Date(startYear + 1, 3, 5);

    // 1. Fetch Data
    const [incomeRes, expenseRes] = await Promise.all([
        _supabase.from('commissions').select('*').not('price', 'is', null),
        _supabase.from('studio_expenses').select('*').order('date', { ascending: false })
    ]);

    if (incomeRes.error || expenseRes.error) return;

    // 2. Filter by Tax Year
    const filteredIncome = incomeRes.data.filter(j => {
        const d = new Date(j.created_at);
        return d >= startDate && d <= endDate;
    });

    const filteredExpenses = expenseRes.data.filter(e => {
        const d = new Date(e.date);
        return d >= startDate && d <= endDate;
    });
// 3. Totals & Logic
const grossRevenue = filteredIncome.reduce((sum, j) => sum + (Number(j.price) || 0), 0);
const totalExpenses = filteredExpenses.reduce((sum, e) => sum + (Number(e.amount) || 0), 0);
const netProfit = grossRevenue - totalExpenses;

// Calculate Tax Estimate
// Note: This assumes 20% flat for side-hustle logic. 
// If sole-trader is your only income, first ¬£12,570 is usually 0%.
const taxPot = netProfit > 0 ? netProfit * 0.20 : 0;
const class2NI = (netProfit > 12570) ? (netProfit - 12570) * 0.06 : 0; // 2024/25 NI Class 4 estimate

// Update Header Stats
document.getElementById('financial-stats').innerHTML = `
    <div class="glass-card p-6 border-l-4 border-blue-400 bg-blue-50/20">
        <p class="text-[9px] font-black uppercase text-gray-400">Est. Tax Bill</p>
        <p class="text-2xl font-black italic text-blue-600">¬£${(taxPot + class2NI).toLocaleString()}</p>
        <p class="text-[8px] font-bold text-blue-400/60 uppercase">Incl. Income Tax & NI Reserve</p>
    </div>
`;
    // 4. Update Header Stats
    document.getElementById('financial-stats').innerHTML = `
        <div class="glass-card p-6 border-l-4 border-pink-400">
            <p class="text-[9px] font-black uppercase text-gray-400">Turnover</p>
            <p class="text-2xl font-black italic">¬£${grossRevenue.toLocaleString()}</p>
        </div>
        <div class="glass-card p-6 border-l-4 border-rose-400">
            <p class="text-[9px] font-black uppercase text-gray-400">Expenses</p>
            <p class="text-2xl font-black italic text-rose-500">¬£${totalExpenses.toLocaleString()}</p>
        </div>
        <div class="glass-card p-6 border-l-4 border-emerald-400 bg-emerald-50/20">
            <p class="text-[9px] font-black uppercase text-gray-400">Net Profit</p>
            <p class="text-2xl font-black italic text-emerald-600">¬£${netProfit.toLocaleString()}</p>
        </div>
        <div class="glass-card p-6 border-l-4 border-blue-400 bg-blue-50/20">
            <p class="text-[9px] font-black uppercase text-gray-400">Take-Home</p>
            <p class="text-2xl font-black italic text-blue-600">¬£${(netProfit - taxPot).toLocaleString()}</p>
            <p class="text-[8px] font-bold text-blue-400/60 uppercase">Post 20% Tax</p>
        </div>
    `;

    // 5. Category Pills
    const catTotals = filteredExpenses.reduce((acc, curr) => {
        acc[curr.category] = (acc[curr.category] || 0) + Number(curr.amount);
        return acc;
    }, {});

    document.getElementById('expense-pills').innerHTML = Object.entries(catTotals).map(([cat, amt]) => `
        <div class="bg-white border border-pink-100 rounded-xl px-4 py-2 shadow-sm">
            <p class="text-[8px] font-black uppercase text-gray-400">${cat}</p>
            <p class="text-xs font-black text-gray-700">¬£${amt.toFixed(2)}</p>
        </div>
    `).join('');

    // 6. Expense Table with Delete Action
    const expenseBody = document.getElementById('expense-tbody');
    expenseBody.innerHTML = filteredExpenses.length ? filteredExpenses.map(e => `
        <tr class="border-b border-pink-50/50 hover:bg-white/50 transition-colors">
            <td class="py-4 pl-2 text-[11px] font-bold text-gray-500">${new Date(e.date).toLocaleDateString()}</td>
            <td class="py-4">
                <span class="px-2 py-1 rounded-md bg-gray-100 text-[9px] font-black uppercase text-gray-400">${e.category}</span>
            </td>
            <td class="py-4 text-xs font-bold text-gray-700">${e.description}</td>
            <td class="py-4 text-right text-xs font-black text-rose-500">¬£${Number(e.amount).toFixed(2)}</td>
            <td class="py-4 text-center">
                ${e.reciept_url ? `<a href="${e.reciept_url}" target="_blank" class="text-pink-400 hover:scale-125 inline-block transition-transform">üìé</a>` : '<span class="opacity-20 text-[10px]">‚àÖ</span>'}
            </td>
            <td class="py-4 text-center">
                <button onclick="deleteExpense('${e.id}', '${e.reciept_url || ''}')" class="text-gray-300 hover:text-rose-500 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mx-auto" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                    </svg>
                </button>
            </td>
        </tr>
    `).join('') : `<tr><td colspan="6" class="py-10 text-center text-gray-300 italic text-xs">No expenses logged for this year.</td></tr>`;

    initRevenueChart(filteredIncome, filteredExpenses);
}
        function updateTaxYearProgress() {
    const today = new Date();
    const currentYear = today.getFullYear();
    
    // Tax year starts April 6th
    let start = new Date(currentYear, 3, 6);
    let end = new Date(currentYear + 1, 3, 5);
    
    // If we are currently between Jan 1st and April 5th, the tax year started LAST year
    if (today < start) {
        start = new Date(currentYear - 1, 3, 6);
        end = new Date(currentYear, 3, 5);
    }
    
    const total = end - start;
    const progress = today - start;
    const percentage = Math.min(Math.max((progress / total) * 100, 0), 100);
    
    const diffDays = Math.ceil((end - today) / (1000 * 60 * 60 * 24));
    
    document.getElementById('yearProgressBar').style.width = `${percentage}%`;
    document.getElementById('daysRemaining').innerText = `${diffDays} days until Tax Year ends (April 5th)`;
}
// Call this on load
updateTaxYearProgress();

// 7. Delete Logic (DB + Storage Cleanup)
async function deleteExpense(id, receiptUrl) {
    if (!confirm("Are you sure you want to delete this expense record? üå∏")) return;

    try {
        // Cleanup storage if receipt exists
        if (receiptUrl && receiptUrl !== '') {
            const fileName = receiptUrl.split('/').pop();
            await _supabase.storage.from('receipts').remove([`receipts/${fileName}`]);
        }

        const { error } = await _supabase.from('studio_expenses').delete().eq('id', id);
        if (error) throw error;

        renderfinancials(); // Refresh UI
    } catch (err) {
        console.error("Delete failed:", err.message);
    }
}
        function initRevenueChart(income, expenses) {
            const ctx = document.getElementById('revenueChart').getContext('2d');
            if (revenueChart) revenueChart.destroy();

            const labels = ["Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec", "Jan", "Feb", "Mar"];
            const incData = new Array(12).fill(0);
            const expData = new Array(12).fill(0);

            income.forEach(j => {
                let m = new Date(j.created_at).getMonth() - 3;
                if (m < 0) m += 12;
                incData[m] += (Number(j.price) || 0);
            });

            expenses.forEach(e => {
                let m = new Date(e.date).getMonth() - 3;
                if (m < 0) m += 12;
                expData[m] += (Number(e.amount) || 0);
            });

            revenueChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        { label: 'Income', data: incData, borderColor: '#f472b6', backgroundColor: 'rgba(244, 114, 182, 0.1)', fill: true, tension: 0.4 },
                        { label: 'Expenses', data: expData, borderColor: '#94a3b8', borderDash: [5, 5], tension: 0.4 }
                    ]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
            });
        }

        function openExpenseModal() {
            document.getElementById('expenseForm').reset();
            document.getElementById('expDate').valueAsDate = new Date();
            document.getElementById('expenseModal').classList.remove('hidden');
        }

        function closeExpenseModal() {
            document.getElementById('expenseModal').classList.add('hidden');
        }

        async function saveExpense() {
            const btn = document.getElementById('btnSaveExpense');
            const file = document.getElementById('expFile').files[0];
            btn.disabled = true;
            btn.innerText = "Processing... ‚ú®";

            try {
                let receiptUrl = null;
                if (file) {
                    const path = `receipts/${Date.now()}_${file.name}`;
                    const { error: upErr } = await _supabase.storage.from('receipts').upload(path, file);
                    if (upErr) throw upErr;
                    receiptUrl = _supabase.storage.from('receipts').getPublicUrl(path).data.publicUrl;
                }

                const { error } = await _supabase.from('studio_expenses').insert([{
                    date: document.getElementById('expDate').value,
                    amount: parseFloat(document.getElementById('expAmount').value),
                    category: document.getElementById('expCategory').value,
                    description: document.getElementById('expDesc').value,
                    reciept_url: receiptUrl
                }]);

                if (error) throw error;
                closeExpenseModal();
                renderfinancials();
            } catch (err) {
                alert(err.message);
            } finally {
                btn.disabled = false;
                btn.innerText = "Save Expense ‚ô°";
            }
        }

        // Initialize on load
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(renderfinancials, 500); 
        });

        async function deleteExpense(id, receiptUrl) {
    if (!confirm("Are you sure you want to delete this expense? This cannot be undone. üå∏")) return;

    try {
        // 1. If there's a receipt, delete it from Storage first
        if (receiptUrl) {
            // Extract the filename from the URL
            const urlParts = receiptUrl.split('/');
            const fileName = urlParts[urlParts.length - 1];
            const filePath = `receipts/${fileName}`;

            const { error: storageError } = await _supabase.storage
                .from('receipts')
                .remove([filePath]);
            
            if (storageError) console.warn("Storage cleanup failed, but proceeding with DB delete:", storageError);
        }

        // 2. Delete from the Database
        const { error } = await _supabase
            .from('studio_expenses')
            .delete()
            .eq('id', id);

        if (error) throw error;

        // 3. Refresh the UI
        showMagicAlert("Deleted! ‚ú®", "Expense record removed.", "success");
        renderfinancials();

    } catch (err) {
        showMagicAlert("Error ‚òÅÔ∏è", err.message, "error");
    }
}

        function exportToCSV() {
    const taxYear = document.getElementById('taxYearFilter').value;
    const rows = document.querySelectorAll('#expense-tbody tr');
    
    // Check if there is data to export
    if (rows.length === 0 || rows[0].innerText.includes("No expenses")) {
        showMagicAlert("Wait! üå∏", "There's no data to export for this year.", "error");
        return;
    }

    let csvContent = "data:text/csv;charset=utf-8,Date,Category,Description,Amount,Receipt URL\n";

    rows.forEach(row => {
        const cols = row.querySelectorAll('td');
        const rowData = [
            cols[0].innerText, // Date
            cols[1].innerText, // Category
            `"${cols[2].innerText.replace(/"/g, '""')}"`, // Description (escaped)
            cols[3].innerText.replace('¬£', '').replace(',', ''), // Amount
            cols[4].querySelector('a')?.href || "No Receipt" // Receipt Link
        ];
        csvContent += rowData.join(",") + "\n";
    });

    const encodedUri = encodeURI(csvContent);
    const link = document.createElement("a");
    link.setAttribute("href", encodedUri);
    link.setAttribute("download", `HanafubukiDoll_Expenses_${taxYear}.csv`);
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}
    </script>

    <div id="expenseModal" class="fixed inset-0 z-[150] hidden bg-black/40 backdrop-blur-sm flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-md rounded-[2.5rem] p-8 shadow-2xl border border-pink-100">
            <h3 class="text-2xl font-black italic mb-6 text-gray-800 text-center">Log Expense ‚ô°</h3>
            <form id="expenseForm" class="space-y-4">
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="text-[10px] font-black uppercase text-pink-400 ml-4 mb-1 block">Date</label>
                        <input type="date" id="expDate" class="w-full p-4 bg-gray-50 rounded-2xl border-none text-sm font-bold outline-none">
                    </div>
                    <div>
                        <label class="text-[10px] font-black uppercase text-pink-400 ml-4 mb-1 block">Amount (¬£)</label>
                        <input type="number" id="expAmount" step="0.01" class="w-full p-4 bg-gray-50 rounded-2xl border-none text-sm font-bold outline-none">
                    </div>
                </div>
                <div>
                    <label class="text-[10px] font-black uppercase text-pink-400 ml-4 mb-1 block">Category</label>
                    <select id="expCategory" class="w-full p-4 bg-gray-50 rounded-2xl border-none text-sm font-bold outline-none">
                        <option value="Materials">Materials & Supplies</option>
                        <option value="Shipping">Shipping & Packaging</option>
                        <option value="Marketing">Marketing & Fees</option>
                        <option value="Office">Office & Tech</option>
                        <option value="Travel">Travel</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <div>
                    <label class="text-[10px] font-black uppercase text-pink-400 ml-4 mb-1 block">Description</label>
                    <input type="text" id="expDesc" class="w-full p-4 bg-gray-50 rounded-2xl border-none text-sm font-bold outline-none">
                </div>
                <div>
                    <label class="text-[10px] font-black uppercase text-pink-400 ml-4 mb-1 block">Receipt</label>
                    <input type="file" id="expFile" accept="image/*" class="text-[10px] text-gray-400 ml-4">
                </div>
                <div class="flex gap-3 pt-4">
                    <button type="button" onclick="closeExpenseModal()" class="flex-1 py-4 text-gray-400 font-black text-[10px] uppercase">Cancel</button>
                    <button type="button" id="btnSaveExpense" onclick="saveExpense()" class="flex-[2] bg-pink-500 text-white py-4 rounded-2xl font-black shadow-lg">Save Expense ‚ô°</button>
                </div>
            </form>
        </div>
    </div>
    
    <script src="global-scripts.js"></script>
    </main> <footer class="max-w-6xl mx-auto p-4 md:p-10 mt-10 space-y-10">
        <div class="glass-card p-8 bg-white/80 border-b-4 border-pink-100">
            <div class="flex items-center gap-3 mb-6">
                <span class="text-xl">üí°</span>
                <h3 class="text-xs font-black uppercase text-gray-400 tracking-widest">Sole Trader Quick Guide</h3>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                <div class="space-y-3">
                    <p class="text-[11px] font-black text-pink-500 uppercase tracking-tighter">What are "Allowable Expenses"?</p>
                    <p class="text-[11px] text-gray-500 leading-relaxed">
                        HMRC only taxes your <b>Profit</b>. If you earn ¬£100 but spent ¬£40 on doll resin, you only pay tax on the remaining ¬£60. Always log your materials!
                    </p>
                </div>
                <div class="space-y-3 border-l border-pink-50 pl-6">
                    <p class="text-[11px] font-black text-emerald-600 uppercase tracking-tighter">The Trading Allowance</p>
                    <p class="text-[11px] text-gray-500 leading-relaxed">
                        You get a <b>¬£1,000 tax-free allowance</b> for hobby income. Once your total sales (Turnover) go over ¬£1,000 in a tax year, you must register as a Sole Trader.
                    </p>
                </div>
                <div class="space-y-3 border-l border-pink-50 pl-6">
                    <p class="text-[11px] font-black text-blue-500 uppercase tracking-tighter">Working from Home</p>
                    <p class="text-[11px] text-gray-500 leading-relaxed">
                        Since HanafubukiDoll is run from home, you can claim a flat rate (Simplified Expenses) for heat/power. No need to keep complex utility receipts!
                    </p>
                </div>
            </div>
        </div>

        <div class="text-center pb-10">
            <p class="text-[9px] font-black uppercase text-gray-300 tracking-[0.2em]">Hanafubuki Studio Management v2.0</p>
            <p class="text-[8px] text-gray-300 mt-2 italic">Remember to back up your records via CSV export regularly! üå∏</p>
        </div>
    </footer>
</body>
</html>
</body>
</html>
