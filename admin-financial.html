<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Financials | HanafubukiDoll Aesthetic Studio</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="global-utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="global-style.css">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        .nav-btn { @apply px-5 py-2 rounded-full font-bold text-sm transition-all; }
        .nav-btn-pink { @apply bg-pink-50 text-pink-500 hover:bg-pink-100; }
        .nav-btn-mint { @apply bg-emerald-50 text-emerald-600 hover:bg-emerald-100; }
        .glass-card { @apply bg-white/70 backdrop-blur-md border border-white/20 rounded-[2rem] shadow-sm; }
    </style>
</head>
<body class="bg-[#fdfbfb]">
    <div class="mesh-bg"></div>

    <nav class="p-4 md:p-6 sticky top-0 z-50 bg-white/80 backdrop-blur-md border-b border-pink-50">
        <div class="max-w-6xl mx-auto flex flex-col md:flex-row justify-between items-center gap-4">
            <div class="text-xl md:text-2xl font-black tracking-tighter">
                <span class="bounce-bunny">üê∞</span> HanafubukiDoll üå∏
            </div>
            <div id="adminNav" class="flex flex-wrap justify-center gap-2 md:gap-4">
                <a href="admin-index.html" class="nav-btn nav-btn-pink">Dashboard ‚ô°</a>
                <a href="admin-workbench.html" class="nav-btn nav-btn-mint">Workbench ‚ô°</a>
                <a href="admin-planner.html" class="nav-btn nav-btn-pink">Planner ‚ô°</a>
                <a href="admin-inventory.html" class="nav-btn nav-btn-mint">Inventory ‚ô°</a>
                <a href="admin-financial.html" class="nav-btn nav-btn-pink border-2 border-pink-200">Financials ‚ô°</a>
                <button onclick="handleLogout()" class="nav-btn nav-btn-mint opacity-50">Logout ‚èª</button>
            </div>
        </div>
    </nav>
    <div class="glass-card p-4 mb-6 bg-white/40 border-none flex flex-wrap items-center justify-between gap-4">
    <div class="flex items-center gap-4">
        <div class="h-10 w-10 rounded-full bg-pink-100 flex items-center justify-center text-xl shadow-sm">üóìÔ∏è</div>
        <div>
            <p class="text-[10px] font-black uppercase text-gray-400 tracking-widest leading-none">
                Tax Year <span id="taxYearDisplay">2025/26</span>
            </p>
            <p class="text-xs font-bold text-gray-700">
                <span id="daysRemainingText" class="text-pink-500">--</span> days until April 5th
            </p>
        </div>
    </div>

    <div class="flex-1 max-w-sm px-6 border-l border-gray-100">
        <div class="flex justify-between mb-1">
            <span class="text-[9px] font-black uppercase text-gray-400">Trading Allowance Tracker</span>
            <span id="allowanceStatus" class="text-[9px] font-black text-pink-500 italic">Calculating...</span>
        </div>
        <div class="w-full bg-gray-100 h-1.5 rounded-full overflow-hidden shadow-inner">
            <div id="allowanceBar" class="h-full transition-all duration-1000" style="width: 0%"></div>
        </div>
    </div>

    <button onclick="toggleTaxModal()" class="px-4 py-2 border border-pink-200 rounded-lg text-[9px] font-black uppercase text-pink-500 hover:bg-pink-50 transition-all">
        Deadlines & Help üå∏
    </button>
</div>
   <main class="max-w-5xl mx-auto p-4 md:p-10 space-y-10">

    <!-- 4 stat cards (Cash, Expenses, Profit, Pending) -->
    <div id="financial-stats" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-10">
        <div class="glass-card p-6 animate-pulse bg-gray-50 h-24"></div>
        <div class="glass-card p-6 animate-pulse bg-gray-50 h-24"></div>
        <div class="glass-card p-6 animate-pulse bg-gray-50 h-24"></div>
        <div class="glass-card p-6 animate-pulse bg-gray-50 h-24"></div>
    </div>

    <!-- Grid: Chart (left 2/3) + sidebar (right 1/3) -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 items-start">
        
        <!-- Chart card (spans 2 columns on lg screens) -->
        <div class="lg:col-span-2 glass-card p-8 bg-white/80 border-none shadow-sm">
            <div class="flex justify-between items-center mb-8">
                <div>
                    <h3 class="text-[10px] font-black uppercase text-gray-400 tracking-widest leading-none mb-1">Performance Overview</h3>
                    <p class="text-lg font-black italic text-gray-800">Revenue vs Expenses</p>
                </div>
                <select id="taxYearFilter" onchange="renderfinancials()" class="text-[10px] font-black border-none bg-pink-50 rounded-lg p-2 outline-none text-pink-500 cursor-pointer">
                    <option value="2025-26">Tax Year 25/26</option>
                    <option value="2024-25">Tax Year 24/25</option>
                </select>
            </div>
            <div class="h-[350px]">
                <canvas id="revenueChart"></canvas>
            </div>
        </div>

        <!-- Sidebar: Tax reserve + categories + tip -->
        <div class="space-y-6">
            <div id="unified-tax-reserve"></div>

            <div class="glass-card p-6 bg-white/80 border-none shadow-sm">
                <h3 class="text-[10px] font-black uppercase text-gray-400 tracking-widest mb-4">Spending by Category</h3>
                <div id="expense-pills" class="flex flex-col gap-2"></div>
            </div>

            <div class="glass-card p-6 bg-gradient-to-br from-emerald-50 to-teal-50 border-none">
                <p class="text-[10px] font-black text-emerald-600 uppercase mb-2">üí° Quick Tip</p>
                <p class="text-[11px] text-emerald-800 font-medium leading-relaxed">
                    Working from home? Use the "Flat Rate" simplified expense to claim heat and light costs!
                </p>
            </div>
        </div>
    </div>

    <!-- Expense Records table (full width, below the grid) -->
    <div class="glass-card p-8 bg-white/80 border-none shadow-sm">
        <div class="flex flex-col md:flex-row justify-between items-center mb-8 gap-4 md:gap-6">
            <div>
                <h3 class="text-xs font-black uppercase text-gray-400 tracking-widest">Expense Records</h3>
                <p class="text-[9px] text-gray-400 uppercase font-bold italic">Self-Assessment Audit Trail</p>
            </div>
            
            <div class="flex gap-3 sm:gap-4">
                <button id="export-csv-btn" class="nav-btn nav-btn-pink text-[10px] whitespace-nowrap px-4 py-2">üíæ Export CSV</button>
                <button id="log-expense-btn" class="nav-btn nav-btn-mint text-[10px] whitespace-nowrap px-4 py-2">+ Log Expense</button>
            </div>
        </div>

        <div class="overflow-x-auto">
            <table class="w-full text-left min-w-[640px]">
                <thead>
                    <tr class="text-[10px] uppercase text-gray-400 border-b border-pink-50">
                        <th class="pb-4 pl-2">Date</th>
                        <th class="pb-4">Category</th>
                        <th class="pb-4">Description</th>
                        <th class="pb-4 text-right">Amount</th>
                        <th class="pb-4 text-center">Action</th>
                    </tr>
                </thead>
                <tbody id="expense-tbody" class="text-sm"></tbody>
            </table>
        </div>
    </div>

</main>
    
 <script>

   function openExpenseModal() {
    document.getElementById('expenseModal').classList.remove('hidden');

    // Set default date to today
    document.querySelector('#expenseForm input[type="date"]').value = new Date().toISOString().split('T')[0];
}

function closeExpenseModal() {
    document.getElementById('expenseModal').classList.add('hidden');
    document.getElementById('expenseForm').reset();
}

// Handle the Form Submission
document.getElementById('expenseForm')?.addEventListener('submit', async (e) => {
    e.preventDefault();

    const formData = new FormData(e.target);

    const expenseData = {

        amount: parseFloat(formData.get('amount')),
        category: formData.get('category'),
        description: formData.get('description'),
        date: formData.get('date')
    };

    const { error } = await _supabase.from('studio_expenses').insert([expenseData]);

    if (error) {
        alert("Error saving expense: " + error.message);
    } else {
        closeExpenseModal();
        renderfinancials(); // Refresh the dashboard
    }
});

     async function deleteExpense(id) {
    // 1. Safety Check: Don't allow deleting 'Virtual' shipping rows
    if (typeof id === 'string' && id.startsWith('ship-')) {
        alert("This is an automatic shipping record derived from your sales. To change this, you must edit the commission's shipping cost.");
        return;
    }

    // 2. Confirmation
    if (!confirm("Are you sure you want to remove this expense record?")) return;

    // 3. Delete from Supabase
    const { error } = await _supabase
        .from('studio_expenses')
        .delete()
        .eq('id', id);

    if (error) {
        alert("Error deleting record: " + error.message);
    } else {
        // 4. Refresh the UI
        renderfinancials();
    }
}


async function uploadShippingReceipt(commissionId) {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = 'image/*,application/pdf';

    input.onchange = async (e) => {
        const file = e.target.files[0];
        if (!file) return;

        if (file.size > 5 * 1024 * 1024) { // optional: 5MB limit
            alert("File too large (max 5MB)");
            return;
        }

        const fileExt = file.name.split('.').pop() || 'jpg';
        const fileName = `shipping_${commissionId}_${Date.now()}.${fileExt}`;
        const filePath = `shipping/${fileName}`; // optional folder in bucket

        const { data: uploadData, error: uploadError } = await _supabase.storage
            .from('receipts') // ‚Üê change if your bucket name is different
            .upload(filePath, file, {
                cacheControl: '3600',
                upsert: false
            });

        if (uploadError) {
            alert("Upload failed: " + uploadError.message);
            console.error(uploadError);
            return;
        }

        // Get public URL
        const { data: urlData } = _supabase.storage
            .from('receipts')
            .getPublicUrl(filePath);

        const receiptUrl = urlData.publicUrl;

        // Save to commissions
        const { error: updateError } = await _supabase
            .from('commissions')
            .update({ shipping_receipt_url: receiptUrl })
            .eq('id', commissionId);

        if (updateError) {
            alert("Failed to save receipt link: " + updateError.message);
            console.error(updateError);
        } else {
            alert("Receipt uploaded and linked!");
            renderfinancials(); // Refresh table ‚Üí shows "View" link now
        }
    };

    input.click();
}

     async function deleteReceipt(id, isVirtual = false) {
    if (!confirm("Are you sure you want to delete this receipt?")) return;

    let updateData = { receipt_url: null };  // for real expenses
    let tableName = 'studio_expenses';
    let idField = 'id';

    if (isVirtual) {
        updateData = { shipping_receipt_url: null };
        tableName = 'commissions';
        idField = 'id';
    }

    const { error } = await _supabase
        .from(tableName)
        .update(updateData)
        .eq(idField, id);

    if (error) {
        alert("Failed to delete receipt link: " + error.message);
        console.error(error);
    } else {
        alert("Receipt removed!");
        renderfinancials();  // Refresh table ‚Üí button goes back to "+ Add receipt"
    }
}
     
     function exportToCSV() {
    // 1. Grab the table rows
    const rows = document.querySelectorAll("#expense-tbody tr");
    if (rows.length === 0 || rows[0].innerText.includes("No records found")) {
        alert("No data to export!");
        return;
    }

    // 2. Define Headers
    let csvContent = "Date,Category,Description,Amount,Type\n";

    // 3. Loop through rows and clean data
    rows.forEach(row => {

        const cols = row.querySelectorAll("td");

        if (cols.length >= 4) {

            const date = cols[0].innerText;
            const category = cols[1].innerText.trim();
            const description = cols[2].innerText.replace(/,/g, ""); // Remove commas so CSV doesn't break
            const amount = cols[3].innerText.replace("¬£", "");
            const type = row.classList.contains('bg-blue-50/20') ? "Auto-Shipping" : "Manual Entry";

            csvContent += `${date},${category},${description},${amount},${type}\n`;
        }
    });

    // 4. Trigger Download
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement("a");
    const url = URL.createObjectURL(blob);
    const taxYear = document.getElementById('taxYearFilter').value;

    link.setAttribute("href", url);
    link.setAttribute("download", `Hanafubuki_Expenses_${taxYear}.csv`);
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

     
  let revenueChart = null;

// Helper: Calculate days until April 5th
function getTaxYearStats() {
    const today = new Date();
    const currentYear = today.getFullYear();
    const taxYearEnd = (today.getMonth() > 3 || (today.getMonth() === 3 && today.getDate() >= 6)) 
        ? new Date(currentYear + 1, 3, 5) 
        : new Date(currentYear, 3, 5);
    const diff = taxYearEnd - today;
    return Math.ceil(diff / (1000 * 60 * 60 * 24));
}

// Helper: Toggle Modal
function toggleTaxModal() {
    const modal = document.getElementById('taxHelpModal');
    if (modal) modal.classList.toggle('hidden');
}

async function renderfinancials() {

    const taxYearFilter = document.getElementById('taxYearFilter');

    if (!taxYearFilter) return;

    const taxYear = taxYearFilter.value;

    const [startYear] = taxYear.split('-').map(Number);

    const startDate = new Date(startYear, 3, 6); 

    const endDate = new Date(startYear + 1, 3, 5);

    // 1. Fetch Data
    const [incomeRes, expenseRes] = await Promise.all([
        _supabase.from('commissions').select('id, total_price, created_at, shipping_cost, payments, customer_name'),
        _supabase.from('studio_expenses').select('*').order('date', { ascending: false })
    ]);

    if (incomeRes.error || expenseRes.error) return;

    // 2. Process Shipping
const shippingExpenses = incomeRes.data
    .filter(c => Number(c.shipping_cost) > 0)
    .map(c => ({
        id: `ship-${c.id}`,
        date: c.created_at,
        category: 'Shipping',
        description: `Postage for ${c.customer_name || 'Commission'}`,
        amount: Number(c.shipping_cost),
        is_virtual: true,
        reciept_url: c.shipping_receipt_url   // ‚Üê add this line (note spelling: reciept_url to match your existing table code)
    }));

    // 3. Combine & Filter
    const allExpenses = [...expenseRes.data, ...shippingExpenses];
    const filteredExpenses = allExpenses.filter(e => {
        const d = new Date(e.date);
        return d >= startDate && d <= endDate;
    });

    // 4. Income Math
    let totalIncomeInYear = 0;
    let totalBookedInYear = 0;
    incomeRes.data.forEach(comm => {

        const commDate = new Date(comm.created_at);
        if (commDate >= startDate && commDate <= endDate) totalBookedInYear += (Number(comm.total_price) || 0);
        if (Array.isArray(comm.payments)) {
            comm.payments.forEach(p => {
                const pDate = new Date(p.date);
                if (pDate >= startDate && pDate <= endDate) totalIncomeInYear += (Number(p.amount) || 0);
            });
        }
    });

    // 5. CORE CALCULATIONS (Fixed order: calculate first!)
   const totalOut = filteredExpenses.reduce((sum, e) => sum + (Number(e.amount) || 0), 0);

    const netProfit = totalIncomeInYear - totalOut;

    const pendingRevenue = totalBookedInYear - totalIncomeInYear;

    const taxPot = netProfit > 1000 ? netProfit * 0.20 : 0; 
   
    const class4NI = (netProfit > 12570) ? (netProfit - 12570) * 0.06 : 0;
    
    const totalTaxNeeded = taxPot + class4NI;

    // 6. Header Update
    const daysLeft = getTaxYearStats();

    document.getElementById('daysRemainingText').innerText = daysLeft;
    document.getElementById('taxYearDisplay').innerText = `${startYear}/${(startYear + 1).toString().slice(-2)}`;

    const allowanceLimit = 1000;

    const cashPercent = Math.min((totalIncomeInYear / allowanceLimit) * 100, 100);

    const pendingPercent = Math.min((pendingRevenue / allowanceLimit) * 100, 100 - cashPercent);

   const allowanceBar = document.getElementById('allowanceBar');

if (allowanceBar) {

   allowanceBar.style.background = `linear-gradient(to right, 
        #ec4899 ${cashPercent}%, 
        rgba(96, 165, 250, 0.4) ${cashPercent}%, 
        rgba(96, 165, 250, 0.4) ${cashPercent + pendingPercent}%, 
        #f3f4f6 ${cashPercent + pendingPercent}%)`;
    allowanceBar.style.width = '100%';
}

const allowanceStatus = document.getElementById('allowanceStatus');
if (allowanceStatus) {
    if (totalIncomeInYear >= allowanceLimit) {
        allowanceStatus.innerHTML = `<span class="text-pink-600 font-black">LIMIT REACHED üì¢</span>`;
    } else {

        allowanceStatus.innerHTML = `
            <span class="text-pink-500">¬£${totalIncomeInYear} Cash</span> + 
            <span class="text-blue-300 italic">¬£${pendingRevenue} Pending</span>`;
    }
}
    // 7. Render Unified Smart Reserve
    const isHobby = totalBookedInYear < 1000;

    const reserveContainer = document.getElementById('unified-tax-reserve');
    if (reserveContainer) {
       reserveContainer.innerHTML = `
    <div class="glass-card p-6 border-l-4 ${totalTaxNeeded > 0 ? 'border-amber-400 bg-amber-50/30' : 'border-emerald-400 bg-emerald-50/20'}">
        <p class="text-[9px] font-black uppercase text-pink-400 tracking-widest mb-1">Tax Savings Pot</p>
        <div class="flex items-baseline gap-2">

            <h3 class="text-2xl font-black italic text-emerald-800">¬£${totalTaxNeeded.toLocaleString(undefined, {minimumFractionDigits: 2})}</h3>
            ${totalTaxNeeded > 0 ? `<span class="text-[10px] text-amber-600 font-bold">READY TO SAVE</span>` : ''}
        </div>

           <div class="mt-4">
            <div class="w-full bg-gray-200/50 h-1.5 rounded-full overflow-hidden">
                <div class="bg-amber-400 h-full transition-all duration-1000" style="width: ${Math.min(100, (totalTaxNeeded / Math.max(1, netProfit)) * 100)}%"></div>
            </div>

            <p class="text-[9px] font-bold text-gray-400 uppercase mt-2">
                ${totalTaxNeeded > 0 ? 'Pot Intensity: ' + ((totalTaxNeeded / netProfit) * 100).toFixed(0) + '%' : (isHobby ? 'Hobby Mode Active üê∞' : 'Status: No Tax Due ‚ú®')}
            </p>
       </div>
    </div>
`;
        
    // 8. Update Stats Grid
    document.getElementById('financial-stats').innerHTML = `
        <div class="glass-card p-6 border-l-4 border-pink-400">
            <p class="text-[9px] font-black uppercase text-gray-400">Cash Received</p>
           <p class="text-2xl font-black italic">¬£${totalIncomeInYear.toLocaleString()}</p>
        </div>

        <div class="glass-card p-6 border-l-4 border-rose-400">
            <p class="text-[9px] font-black uppercase text-gray-400">Total Expenses</p>
            <p class="text-2xl font-black italic text-rose-500">¬£${totalOut.toLocaleString()}</p>
        </div>

        <div class="glass-card p-6 border-l-4 border-emerald-400 bg-emerald-50/20">
            <p class="text-[9px] font-black uppercase text-gray-400">Net Profit</p>
            <p class="text-2xl font-black italic text-emerald-600">¬£${netProfit.toLocaleString()}</p>
       </div>

        <div class="glass-card p-6 border-l-4 border-blue-400 bg-blue-50/20">
           <p class="text-[9px] font-black uppercase text-gray-400">Pending Revenue</p>
            <p class="text-2xl font-black italic text-blue-600">¬£${pendingRevenue.toLocaleString()}</p>
        </div>`;

    // 9. Categories and Table (Simplified)
    const catTotals = filteredExpenses.reduce((acc, curr) => {
        acc[curr.category] = (acc[curr.category] || 0) + Number(curr.amount);
        return acc;
    }, {});

 document.getElementById('expense-pills').innerHTML = Object.entries(catTotals).map(([cat, amt]) => `
    <div class="flex items-center gap-3 bg-white px-4 py-2 rounded-xl shadow-sm border border-pink-50">
        <span class="text-[9px] font-black uppercase text-gray-400">${cat}</span>
        <span class="text-xs font-black text-pink-500">¬£${amt.toFixed(2)}</span>
    </div>
`).join('');

    document.getElementById('expense-tbody').innerHTML = filteredExpenses.length ? filteredExpenses.map(e => `

        <tr class="border-b border-pink-50/50 hover:bg-white/50 transition-colors ${e.is_virtual ? 'bg-blue-50/20' : ''}">
            <td class="py-4 pl-2 text-[11px] font-bold text-gray-500">${new Date(e.date).toLocaleDateString()}</td>
            <td class="py-4"><span class="px-2 py-1 rounded-md ${e.is_virtual ? 'bg-blue-100 text-blue-500' : 'bg-gray-100 text-gray-400'} text-[9px] font-black uppercase">${e.category}</span></td>
            <td class="py-4 text-xs font-bold text-gray-700">${e.description}</td>
            <td class="py-4 text-right text-xs font-black text-rose-500">¬£${Number(e.amount).toFixed(2)}</td>
            <td class="py-4 text-center">
   <td class="py-4 text-center">
    ${e.reciept_url 
        ? `
            <a href="${e.reciept_url}" target="_blank" class="text-blue-500 hover:underline text-sm mr-2">üìé View</a>
            <button onclick="deleteReceipt('${e.is_virtual ? 'ship-' + commissionIdFromVirtual(e) : e.id}', ${e.is_virtual})" class="text-rose-500 hover:text-rose-700 text-xs">üóë Delete</button>
          `
        : (e.is_virtual 
            ? `<button onclick="uploadShippingReceipt('${e.id.replace('ship-', '')}')" class="text-blue-500 hover:underline text-xs">+ Add receipt</button>`
            : '‚àÖ')}
</td>
<td class="py-4 text-center">
    ${e.is_virtual ? '' : `<button onclick="deleteExpense('${e.id}')" class="text-gray-300 hover:text-rose-500">√ó</button>`}
</td>
        </tr>`).join('') : `<tr><td colspan="6" class="py-10 text-center text-gray-300 italic text-xs">No records found.</td></tr>`;

    if (typeof initRevenueChart === 'function') initRevenueChart(incomeRes.data, filteredExpenses);
}

// Chart Initialization
function initRevenueChart(incomeData, expenses) {
    const ctx = document.getElementById('revenueChart').getContext('2d');
    if (window.revenueChartInstance) window.revenueChartInstance.destroy();

    const labels = ["Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec", "Jan", "Feb", "Mar"];
    const incData = new Array(12).fill(0);
    const expData = new Array(12).fill(0);

    incomeData.forEach(comm => {
        if (Array.isArray(comm.payments)) {
            comm.payments.forEach(p => {
                let m = new Date(p.date).getMonth() - 3;
                if (m < 0) m += 12;
                if (m >= 0 && m < 12) incData[m] += (Number(p.amount) || 0);
            });
        }
    });

    expenses.forEach(e => {
        let m = new Date(e.date).getMonth() - 3;
        if (m < 0) m += 12;
        if (m >= 0 && m < 12) expData[m] += (Number(e.amount) || 0);
    });

    window.revenueChartInstance = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [
                { label: 'Income', data: incData, borderColor: '#f472b6', backgroundColor: 'rgba(244, 114, 182, 0.1)', fill: true, tension: 0.4 },
                { label: 'Expenses', data: expData, borderColor: '#94a3b8', borderDash: [5, 5], tension: 0.4 }
            ]
        },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
    });
}


     
document.addEventListener('DOMContentLoaded', () => {
    setTimeout(renderfinancials, 500); 
});
}
  
document.addEventListener('DOMContentLoaded', function() {
    const exportBtn = document.getElementById('export-csv-btn');
    if (exportBtn) {
        exportBtn.addEventListener('click', exportToCSV);
    }

    const addBtn = document.getElementById('log-expense-btn');
    if (addBtn) {
        addBtn.addEventListener('click', openExpenseModal);
    }

   });

     function commissionIdFromVirtual(virtualId) {
    return virtualId.replace('ship-', '');
}
     
async function handleLogout() {
            await _supabase.auth.signOut();
            window.location.href = 'customer-index.html';
        }

     
    </script>
    <div id="expenseModal" class="hidden fixed inset-0 bg-gray-900/60 backdrop-blur-sm z-[200] flex items-center justify-center p-4">
    <div class="bg-white rounded-[2.5rem] max-w-md w-full p-8 shadow-2xl border border-pink-100">
        <h3 class="text-xl font-black italic text-gray-800 mb-6">Log New Expense üå∏</h3>
        <form id="expenseForm" class="space-y-4">
            <div>
                <label class="text-[10px] font-black uppercase text-gray-400 ml-2">Amount (¬£)</label>
                <input type="number" step="0.01" name="amount" required class="w-full px-5 py-3 rounded-2xl border-2 border-pink-50 focus:border-pink-200 outline-none font-bold">
            </div>
            <div>
                <label class="text-[10px] font-black uppercase text-gray-400 ml-2">Category</label>
                <select name="category" class="w-full px-5 py-3 rounded-2xl border-2 border-pink-50 focus:border-pink-200 outline-none font-bold">
                    <option value="Materials">Materials & Stock</option>
                    <option value="Packaging">Packaging</option>
                    <option value="Software/Sub">Software & Subscriptions</option>
                    <option value="Marketing">Marketing/Ads</option>
                    <option value="Other">Other Business Cost</option>
                </select>
            </div>
            <div>
                <label class="text-[10px] font-black uppercase text-gray-400 ml-2">Description</label>
                <input type="text" name="description" placeholder="e.g. New Resin Supply" required class="w-full px-5 py-3 rounded-2xl border-2 border-pink-50 focus:border-pink-200 outline-none font-bold">
            </div>
            <div>
                <label class="text-[10px] font-black uppercase text-gray-400 ml-2">Date</label>
                <input type="date" name="date" required class="w-full px-5 py-3 rounded-2xl border-2 border-pink-50 focus:border-pink-200 outline-none font-bold">
            </div>
            
            <div class="flex gap-3 pt-4">
                <button type="button" onclick="closeExpenseModal()" class="flex-1 py-4 bg-gray-100 text-gray-500 font-black uppercase tracking-widest rounded-2xl hover:bg-gray-200 transition-all">Cancel</button>
                <button type="submit" class="flex-1 py-4 bg-pink-500 text-white font-black uppercase tracking-widest rounded-2xl hover:bg-pink-600 transition-all shadow-lg shadow-pink-200">Save</button>
            </div>
        </form>
    </div>
</div>
    
    <script src="global-scripts.js"></script>
    </main>
    
    <div class="fixed bottom-6 left-6 z-[100] flex flex-col items-start gap-4">
    <div id="accessMenu" class="w-80 bg-white rounded-3xl shadow-2xl border border-pink-50 overflow-hidden hidden animate-fadeIn mb-2">
        <div class="flex border-b border-pink-50">
            <button onclick="switchTab('settings')" id="tab-settings" class="flex-1 py-4 text-[10px] font-black uppercase tracking-widest text-pink-500 border-b-2 border-pink-500 bg-pink-50/30">Settings</button>
            <button onclick="switchTab('tax')" id="tab-tax" class="flex-1 py-4 text-[10px] font-black uppercase tracking-widest text-gray-400 hover:text-pink-400 transition-colors">Tax Guide</button>
            <button onclick="ComfortSettings.toggleMenu()" class="px-4 text-gray-300 hover:text-pink-500 text-2xl">&times;</button>
        </div>

        <div class="p-6">
            <div id="panel-settings" class="space-y-5">
                <label class="flex justify-between items-center cursor-pointer group">
                    <span class="text-[11px] font-bold text-gray-600 uppercase group-hover:text-pink-400 transition-colors">Dark Mode</span>
                    <input type="checkbox" id="darkToggle" onchange="ComfortSettings.update('dark-theme', this.checked)" class="w-5 h-5 accent-pink-500">
                </label>
                <label class="flex justify-between items-center cursor-pointer group">
                    <span class="text-[11px] font-bold text-gray-600 uppercase group-hover:text-pink-400 transition-colors">Reduce Motion</span>
                    <input type="checkbox" id="motionToggle" onchange="ComfortSettings.update('reduced-motion', this.checked)" class="w-5 h-5 accent-pink-500">
                </label>
                <label class="flex justify-between items-center cursor-pointer group">
                    <span class="text-[11px] font-bold text-gray-600 uppercase group-hover:text-pink-400 transition-colors">Dyslexia Font</span>
                    <input type="checkbox" id="dyslexiaToggle" onchange="ComfortSettings.update('dyslexia-mode', this.checked)" class="w-5 h-5 accent-pink-500">
                </label>
            </div>

            <div id="panel-tax" class="hidden space-y-4">
                <div class="bg-pink-50/50 p-3 rounded-xl border border-pink-100">
                    <p class="text-[10px] font-black text-pink-600 uppercase mb-1">Allowable Expenses</p>
                    <p class="text-[10px] text-gray-500 leading-tight">Deduct resin, hair, eyes, and Etsy fees from turnover. You only pay tax on <b>Profit</b>.</p>
                </div>
                <div class="bg-emerald-50/50 p-3 rounded-xl border border-emerald-100">
                    <p class="text-[10px] font-black text-emerald-600 uppercase mb-1">Trading Allowance</p>
                    <p class="text-[10px] text-gray-500 leading-tight">If gross sales are <b>under ¬£1,000/year</b>, you usually don't need to register as a Sole Trader.</p>
                </div>
                <div class="bg-blue-50/50 p-3 rounded-xl border border-blue-100">
                    <p class="text-[10px] font-black text-blue-600 uppercase mb-1">Home Office</p>
                    <p class="text-[10px] text-gray-500 leading-tight">Working from home? Use the 'Flat Rate' simplified expense to claim power/heat costs easily.</p>
                </div>
            </div>
        </div>
    </div>
    
    <button onclick="ComfortSettings.toggleMenu()" class="access-btn flex items-center gap-2 px-5 py-3 bg-white border-2 border-pink-100 rounded-full shadow-lg hover:scale-105 transition-all">
        <span>‚öôÔ∏è</span>
        <span class="text-[11px] font-black uppercase tracking-widest text-gray-700">Studio Settings</span>
    </button>
</div>
    <footer class="py-20 text-center border-t border-pink-50 bg-white/30">
    <p class="text-sm tracking-widest uppercase font-bold text-pink-400 mb-4">HanafubukiDoll Aesthetic Studio</p>
    <p class="text-gray-400 text-sm mb-6">¬© 2026 ‚Ä¢ Made with cherry blossoms and magic! üê∞üå∏üåô</p>
</footer>
    <div id="taxHelpModal" class="hidden fixed inset-0 bg-gray-900/60 backdrop-blur-sm z-[200] flex items-center justify-center p-4">
    <div class="bg-white rounded-[2.5rem] max-w-lg w-full p-8 shadow-2xl relative border border-pink-100">
        <button onclick="toggleTaxModal()" class="absolute top-6 right-6 text-gray-400 hover:text-rose-500 text-2xl font-bold">√ó</button>
        
        <h3 class="text-xl font-black italic text-gray-800 mb-4">The Tax Roadmap üó∫Ô∏è</h3>
        
        <div class="space-y-4">
            <div class="p-4 bg-pink-50 rounded-2xl border border-pink-100">
                <p class="text-[10px] font-black text-pink-500 uppercase">April 6th ‚Äî April 5th</p>
                <p class="text-xs text-gray-600 font-bold mt-1">The UK Tax Year. Record every payment received in this window.</p>
            </div>
            
            <div class="p-4 bg-blue-50 rounded-2xl border border-blue-100">
                <p class="text-[10px] font-black text-blue-500 uppercase tracking-widest">October 5th Deadline</p>
                <p class="text-xs text-gray-600 font-bold mt-1">If you crossed the ¬£1,000 threshold in the previous tax year, register by this date.</p>
            </div>

            <div class="p-4 bg-emerald-50 rounded-2xl border border-emerald-100">
                <p class="text-[10px] font-black text-emerald-600 uppercase tracking-widest">January 31st Deadline</p>
                <p class="text-xs text-gray-600 font-bold mt-1">Deadline to file your return and pay the tax you owe.</p>
            </div>
        </div>

        <a href="https://www.gov.uk/register-for-self-assessment" target="_blank" class="block w-full mt-6 text-center py-4 bg-pink-500 text-white font-black uppercase tracking-widest rounded-2xl hover:bg-pink-600 transition-colors shadow-lg shadow-pink-200">
            Register with HMRC üîó
        </a>
    </div>
</div>
</body>
</html>
